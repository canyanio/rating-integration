
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="ie=edge" http-equiv="x-ua-compatible"/>
<meta content="Data-Driven Intelligence for the communication and IoT industries" name="description"/>
<link href="https://canyanio.github.io/rating-integration/tutorials/kamailio-integration/" rel="canonical"/>
<meta content="Canyan.io" name="author"/>
<meta content="Copy to clipboard" name="lang:clipboard.copy"/>
<meta content="Copied to clipboard" name="lang:clipboard.copied"/>
<meta content="en" name="lang:search.language"/>
<meta content="True" name="lang:search.pipeline.stopwords"/>
<meta content="True" name="lang:search.pipeline.trimmer"/>
<meta content="No matching documents" name="lang:search.result.none"/>
<meta content="1 matching document" name="lang:search.result.one"/>
<meta content="# matching documents" name="lang:search.result.other"/>
<meta content="[\s\-]+" name="lang:search.tokenizer"/>
<link href="../../favicon.ico" rel="shortcut icon"/>
<meta content="mkdocs-1.0.4, mkdocs-material-4.6.0" name="generator"/>
<title>Kamailio Integration - Canyan Rating</title>
<link href="../../assets/stylesheets/application.1b62728e.css" rel="stylesheet"/>
<link href="../../assets/stylesheets/application-palette.a8b3c06d.css" rel="stylesheet"/>
<meta content="#7e57c2" name="theme-color"/>
<script src="../../assets/javascripts/modernizr.268332fc.js"></script>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro,+Helvetica,+sans-serif:300,400,400i,700%7CUbuntu+Mono&amp;display=fallback" rel="stylesheet"/>
<style>body,input{font-family:"Source Sans Pro, Helvetica, sans-serif","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Ubuntu Mono","Courier New",Courier,monospace}</style>
<link href="../../assets/fonts/material-icons.css" rel="stylesheet"/>
<script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-141188366-2", "auto")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script>
<script async="" src="https://www.google-analytics.com/analytics.js"></script>
</head>
<body data-md-color-accent="deep-purple" data-md-color-primary="deep-purple" dir="ltr">
<svg class="md-svg">
<defs>
</defs>
</svg>
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
<a class="md-skip" href="#integration-with-kamailio" tabindex="1">
        Skip to content
      </a>
<header class="md-header" data-md-component="header">
<nav class="md-header-nav md-grid">
<div class="md-flex">
<div class="md-flex__cell md-flex__cell--shrink">
<a class="md-header-nav__button md-logo" href="https://canyanio.github.io/rating-integration/" title="Canyan Rating">
<img height="24" src="../../logo.png" width="24"/>
</a>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
</div>
<div class="md-flex__cell md-flex__cell--stretch">
<div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
<span class="md-header-nav__topic">
              Canyan Rating
            </span>
<span class="md-header-nav__topic">
              
                Kamailio Integration
              
            </span>
</div>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
</div>
</div>
</nav>
</header>
<div class="md-container">
<main class="md-main" role="main">
<div class="md-main__inner md-grid" data-md-component="container">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title md-nav__title--site" for="__drawer">
<a class="md-nav__button md-logo" href="https://canyanio.github.io/rating-integration/" title="Canyan Rating">
<img height="48" src="../../logo.png" width="48"/>
</a>
    Canyan Rating
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../.." title="Home">
      Home
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../whats-new/" title="What's New ?">
      What's New ?
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../getting-started/" title="Getting started">
      Getting started
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../running/" title="Running">
      Running
    </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" id="nav-5" type="checkbox"/>
<label class="md-nav__link" for="nav-5">
      Agent
    </label>
<nav class="md-nav" data-md-component="collapsible" data-md-level="1">
<label class="md-nav__title" for="nav-5">
        Agent
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../agent/agent/" title="Introduction">
      Introduction
    </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-2" id="nav-5-2" type="checkbox"/>
<label class="md-nav__link" for="nav-5-2">
      Endpoints
    </label>
<nav class="md-nav" data-md-component="collapsible" data-md-level="2">
<label class="md-nav__title" for="nav-5-2">
        Endpoints
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../agent/endpoints/authorization/" title="Authorization">
      Authorization
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../agent/endpoints/transaction-begin/" title="Begin Transaction">
      Begin Transaction
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../agent/endpoints/transaction-end/" title="End Transaction">
      End Transaction
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../agent/endpoints/transaction-record/" title="Record Transaction">
      Record Transaction
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../agent/endpoints/transaction-rollback/" title="Rollback Transaction">
      Rollback Transaction
    </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" id="nav-6" type="checkbox"/>
<label class="md-nav__link" for="nav-6">
      API
    </label>
<nav class="md-nav" data-md-component="collapsible" data-md-level="1">
<label class="md-nav__title" for="nav-6">
        API
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/api/" title="Introduction">
      Introduction
    </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-toggle md-nav__toggle" data-md-toggle="nav-6-2" id="nav-6-2" type="checkbox"/>
<label class="md-nav__link" for="nav-6-2">
      Endpoints
    </label>
<nav class="md-nav" data-md-component="collapsible" data-md-level="2">
<label class="md-nav__title" for="nav-6-2">
        Endpoints
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/endpoints/carrier/" title="Carrier">
      Carrier
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/endpoints/pricelist/" title="Pricelist">
      Pricelist
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/endpoints/rate/" title="Rate">
      Rate
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/endpoints/account/" title="Account">
      Account
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/endpoints/transaction/" title="Transaction">
      Transaction
    </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../engine/" title="Engine">
      Engine
    </a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-toggle md-nav__toggle" data-md-toggle="nav-8" id="nav-8" type="checkbox"/>
<label class="md-nav__link" for="nav-8">
      Tutorials
    </label>
<nav class="md-nav" data-md-component="collapsible" data-md-level="1">
<label class="md-nav__title" for="nav-8">
        Tutorials
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../inserting-data/" title="Inserting Data">
      Inserting Data
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../authorizations/" title="Authorizations">
      Authorizations
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../transactions/" title="Transactions">
      Transactions
    </a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-toggle md-nav__toggle" data-md-toggle="toc" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
        Kamailio Integration
      </label>
<a class="md-nav__link md-nav__link--active" href="./" title="Kamailio Integration">
      Kamailio Integration
    </a>
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#prerequisites">
    Prerequisites
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#scope">
    Scope
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#kamailio-configuration">
    Kamailio configuration
  </a>
<nav class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#authorization">
    Authorization
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#begin-transaction">
    Begin Transaction
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#end-transaction">
    End Transaction
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#testing">
    Testing
  </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../faq/" title="FAQ">
      FAQ
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../license/" title="License">
      License
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../contributing/" title="Contributing">
      Contributing
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../code-of-conduct/" title="Code of conduct">
      Code of conduct
    </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#prerequisites">
    Prerequisites
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#scope">
    Scope
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#kamailio-configuration">
    Kamailio configuration
  </a>
<nav class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#authorization">
    Authorization
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#begin-transaction">
    Begin Transaction
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#end-transaction">
    End Transaction
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#testing">
    Testing
  </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<h1 id="integration-with-kamailio">Integration with Kamailio</h1>
<p><a href="https://www.kamailio.org/">Kamailio</a> is an Open Source SIP Server released under GPL, able to handle thousands of call setups per second. Kamailio can be used to build large platforms for VoIP and realtime communications – presence, WebRTC, Instant messaging and other applications.  Moreover, it can be easily used for scaling up SIP-to-PSTN gateways, PBX systems or media servers like Asterisk™, FreeSWITCH™ or SEMS.</p>
<h2 id="prerequisites">Prerequisites</h2>
<p>The test environment should be set up and running successfully as described in <a href="/running.md">Running Canyan Rating</a> section.
You should have a basic set of data populated in your Canyan Rating instance as described in the <a href="/tutorials/inserting-data/">Inserting Data Tutorial</a>.
The following commands and requests relay on the same data inserted in the above tutorial. If you populated different data you should change the commands in this tutorial accordingly.</p>
<p>After cloning the <a href="https://github.com/canyanio/rating-integration">integration repository</a> the <a href="https://github.com/canyanio/rating-integration/blob/master/Makefile">Makefile</a> provides us with two shortcut commands:
<code>make start</code> and <code>make stop</code>.</p>
<h2 id="scope">Scope</h2>
<p>Integrating the authorization, begin and start transaction methods of the Rating Engine in a Kamailio instance.
Kamailio needs to perform an authorization for every outgoing and incoming call, getting all the information needed to perform or not the calls. Also the begin and end of a call needs to be signalized to the Rating Engine.</p>
<p>The Rating Agent is listening for http requests with REST and GraphQL APIs. In Kamailio we will use the <a href="https://www.kamailio.org/docs/modules/stable/modules/http_async_client.html">HTTP_ASYNC_CLIENT Module</a> to avoid binding Kamailio workers with synchronous http calls.</p>
<h2 id="kamailio-configuration">Kamailio configuration</h2>
<p>The integration repository contains an <a href="https://github.com/canyanio/rating-integration/blob/master/conf/kamailio/rating.cfg">example configuration file</a> for the integration with Canyan's Rating Engine.</p>
<blockquote>
<p><strong>Note:</strong> The Kamailio configuration file is simple and basic for the purpose 
of this tutorial and should not be used in production.</p>
</blockquote>
<h3 id="authorization">Authorization</h3>
<p>Let's start with the authorization method of the Rating Engine.
In the <a href="https://github.com/canyanio/rating-integration/blob/master/conf/kamailio/kamailio.cfg">kamailio.cfg</a> we can notice this piece of code:</p>
<div class="codehilite"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">is_method</span><span class="p">(</span><span class="ss">"INVITE"</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">has_totag</span><span class="p">())</span> <span class="err">{</span>
  <span class="err">$</span><span class="n">dlg_var</span><span class="p">(</span><span class="n">account_tag</span><span class="p">)</span> <span class="o">=</span> <span class="err">$</span><span class="n">fU</span><span class="p">;</span>

  <span class="n">route</span><span class="p">(</span><span class="n">RATING_AUTHORIZATION</span><span class="p">);</span>
<span class="err">}</span>
</pre></div>
<p>The route <code>RATING_AUTHORIZATION</code> is run for every new <code>INVITE</code> method that does not have a <code>to</code> tag.</p>
<p><code>RATING_AUTHORIZATION</code> prepares the json to be sent to the Rating Agent populating the following variables:</p>
<ul>
<li>transaction_tag (<code>$ci</code>)</li>
<li>account_tag (<code>$dlg_var(account_tag)</code>)</li>
<li>source (<code>$fu</code>)</li>
<li>destination (<code>$tu</code>)</li>
</ul>
<p>The route <code>RATING_AUTHORIZATION_RESPONSE</code> is the most complex of the Canyan Rating Engine Kamailio integration routes.
It handles the response from the Agent to the <code>authorization</code> endpoint request.
Let's break it down and see what it does.</p>
<p>The first check is performed on the response from the Agent module. It checks if the http response is 200 then it checks if the response contains the expected fields.</p>
<p>Then the max available units are set to a variable that will be used if the call is authorized to set the dialog timeout with <code>dlg_set_timeout</code>.</p>
<p>The check of the unauthorized reasons is then performed to send the correct reply to the SIP client.</p>
<p>It there are no errors the prioritized carriers list is gathered from the authorization response and the list is parsed with the route <code>RATING_AUTHORIZATION_PARSE_CARRIERS</code>.</p>
<p>At the end of the route the <code>SIPOUT</code> route is called.</p>
<h3 id="begin-transaction">Begin Transaction</h3>
<p>The route <code>RATING_BEGIN_TRANSACTION</code> is called with the event route <a href="https://kamailio.org/docs/modules/stable/modules/dialog.html#idm1446">dialog:start</a>.</p>
<p>The route prepares the following variables for the Rating Agent http async call:</p>
<ul>
<li>transaction_tag (<code>$ci</code>)</li>
<li>account_tag (<code>$dlg_var(account_tag)</code>)</li>
<li>source (<code>$fu</code>)</li>
<li>destination (<code>$tu</code>)</li>
</ul>
<p>Then the route <code>RATING_BEGIN_TRANSACTION_RESPONSE</code> that handles the response from the Agent is doing some simple checks like <code>http_ok</code> and if the http response code is 200. After that the check of the content of the response is performed and it consists in checking if the variable <code>ok</code> is true.</p>
<p>If some of the checks are not good the route sends a 500 reply to che client with a message that the Rating is not available. The route also prints an xlog with alert log level and the http error.</p>
<h3 id="end-transaction">End Transaction</h3>
<p>The route <code>RATING_END_TRANSACTION</code> sets the following variables to be sent to the Agent via http async call:</p>
<ul>
<li>transaction_tag (<code>$ci</code>)</li>
<li>account_tag (<code>$dlg_var(account_tag)</code>)</li>
<li>source (<code>$var(query)</code>)</li>
<li>destination (<code>$var(query)</code>)</li>
</ul>
<p>As for the Begin Transaction there is a simple <code>RATING_END_TRANSACTION_RESPONSE</code> route that handles the response and checks the correct http response and the value of the <code>ok</code> boolean variable inside the response body.
It sends SIP error replies and logs with alert log level the issue.</p>
<h2 id="testing">Testing</h2>
<p>The integration repository contains also <a href="https://github.com/canyanio/rating-integration/tree/master/tests">tests</a> that can be run with a simple <code>make test</code> after the <code>make start</code> command. Plese refer to those tests to see how this implementation inside kamailio is tested with Canyan Rating Engine.
The tests are run with the open source tool <a href="https://github.com/wazo-platform/wazo-tester">wazo-tester</a> so refer to the documentation of that tool for better understanding of the test process.</p>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav class="md-footer-nav__inner md-grid">
<a class="md-flex md-footer-nav__link md-footer-nav__link--prev" href="../transactions/" rel="prev" title="Transactions">
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
</div>
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
                  Previous
                </span>
                Transactions
              </span>
</div>
</a>
<a class="md-flex md-footer-nav__link md-footer-nav__link--next" href="../../faq/" rel="next" title="FAQ">
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
                  Next
                </span>
                FAQ
              </span>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
<div class="md-footer-copyright__highlight">
            Copyright © 2020 Canyan.io
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
</div>
<div class="md-footer-social">
<link href="../../assets/fonts/font-awesome.css" rel="stylesheet"/>
<a class="md-footer-social__link fa fa-github" href="https://github.com/canyanio"></a>
<a class="md-footer-social__link fa fa-twitter" href="https://twitter.com/canyan_io"></a>
<a class="md-footer-social__link fa fa-linkedin" href="https://www.linkedin.com/company/canyan/"></a>
<a class="md-footer-social__link fa fa-slack" href="https://join.slack.com/t/canyanio/shared_invite/enQtODIyODY5MDIyMTMxLTExYjkwZmFkMjBiZWI3ZDEyZjYzYjE2N2M2NWRkZGUwYjdhZmE0YjRkNTQ1MGFmMGJmZjczYzkzYzk0ZWZiMzY"></a>
</div>
</div>
</div>
</footer>
</div>
<script src="../../assets/javascripts/application.808e90bb.js"></script>
<script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
<script src="https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js"></script>
</body>
</html>
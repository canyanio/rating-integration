
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="ie=edge" http-equiv="x-ua-compatible"/>
<meta content="Data-Driven Intelligence for the communication and IoT industries" name="description"/>
<link href="https://canyanio.github.io/rating-integration/tutorials/opensips-integration/" rel="canonical"/>
<meta content="Canyan.io" name="author"/>
<meta content="Copy to clipboard" name="lang:clipboard.copy"/>
<meta content="Copied to clipboard" name="lang:clipboard.copied"/>
<meta content="en" name="lang:search.language"/>
<meta content="True" name="lang:search.pipeline.stopwords"/>
<meta content="True" name="lang:search.pipeline.trimmer"/>
<meta content="No matching documents" name="lang:search.result.none"/>
<meta content="1 matching document" name="lang:search.result.one"/>
<meta content="# matching documents" name="lang:search.result.other"/>
<meta content="[\s\-]+" name="lang:search.tokenizer"/>
<link href="../../favicon.ico" rel="shortcut icon"/>
<meta content="mkdocs-1.0.4, mkdocs-material-4.6.0" name="generator"/>
<title>Opensips Integration - Canyan Rating</title>
<link href="../../assets/stylesheets/application.1b62728e.css" rel="stylesheet"/>
<link href="../../assets/stylesheets/application-palette.a8b3c06d.css" rel="stylesheet"/>
<meta content="#7e57c2" name="theme-color"/>
<script src="../../assets/javascripts/modernizr.268332fc.js"></script>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro,+Helvetica,+sans-serif:300,400,400i,700%7CUbuntu+Mono&amp;display=fallback" rel="stylesheet"/>
<style>body,input{font-family:"Source Sans Pro, Helvetica, sans-serif","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Ubuntu Mono","Courier New",Courier,monospace}</style>
<link href="../../assets/fonts/material-icons.css" rel="stylesheet"/>
<script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-141188366-2", "auto")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script>
<script async="" src="https://www.google-analytics.com/analytics.js"></script>
</head>
<body data-md-color-accent="deep-purple" data-md-color-primary="deep-purple" dir="ltr">
<svg class="md-svg">
<defs>
</defs>
</svg>
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
<a class="md-skip" href="#integration-with-opensips" tabindex="1">
        Skip to content
      </a>
<header class="md-header" data-md-component="header">
<nav class="md-header-nav md-grid">
<div class="md-flex">
<div class="md-flex__cell md-flex__cell--shrink">
<a class="md-header-nav__button md-logo" href="https://canyanio.github.io/rating-integration/" title="Canyan Rating">
<img height="24" src="../../logo.png" width="24"/>
</a>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
</div>
<div class="md-flex__cell md-flex__cell--stretch">
<div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
<span class="md-header-nav__topic">
              Canyan Rating
            </span>
<span class="md-header-nav__topic">
              
                Opensips Integration
              
            </span>
</div>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
</div>
</div>
</nav>
</header>
<div class="md-container">
<main class="md-main" role="main">
<div class="md-main__inner md-grid" data-md-component="container">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title md-nav__title--site" for="__drawer">
<a class="md-nav__button md-logo" href="https://canyanio.github.io/rating-integration/" title="Canyan Rating">
<img height="48" src="../../logo.png" width="48"/>
</a>
    Canyan Rating
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../.." title="Home">
      Home
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../whats-new/" title="What's New ?">
      What's New ?
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../getting-started/" title="Getting started">
      Getting started
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../running/" title="Running">
      Running
    </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" id="nav-5" type="checkbox"/>
<label class="md-nav__link" for="nav-5">
      Agent
    </label>
<nav class="md-nav" data-md-component="collapsible" data-md-level="1">
<label class="md-nav__title" for="nav-5">
        Agent
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../agent/agent/" title="Introduction">
      Introduction
    </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-2" id="nav-5-2" type="checkbox"/>
<label class="md-nav__link" for="nav-5-2">
      Endpoints
    </label>
<nav class="md-nav" data-md-component="collapsible" data-md-level="2">
<label class="md-nav__title" for="nav-5-2">
        Endpoints
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../agent/endpoints/authorization/" title="Authorization">
      Authorization
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../agent/endpoints/transaction-begin/" title="Begin Transaction">
      Begin Transaction
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../agent/endpoints/transaction-end/" title="End Transaction">
      End Transaction
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../agent/endpoints/transaction-record/" title="Record Transaction">
      Record Transaction
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../agent/endpoints/transaction-rollback/" title="Rollback Transaction">
      Rollback Transaction
    </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../hep-agent/" title="HEP Agent">
      HEP Agent
    </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" id="nav-7" type="checkbox"/>
<label class="md-nav__link" for="nav-7">
      API
    </label>
<nav class="md-nav" data-md-component="collapsible" data-md-level="1">
<label class="md-nav__title" for="nav-7">
        API
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/api/" title="Introduction">
      Introduction
    </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-toggle md-nav__toggle" data-md-toggle="nav-7-2" id="nav-7-2" type="checkbox"/>
<label class="md-nav__link" for="nav-7-2">
      Endpoints
    </label>
<nav class="md-nav" data-md-component="collapsible" data-md-level="2">
<label class="md-nav__title" for="nav-7-2">
        Endpoints
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/endpoints/carrier/" title="Carrier">
      Carrier
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/endpoints/pricelist/" title="Pricelist">
      Pricelist
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/endpoints/rate/" title="Rate">
      Rate
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/endpoints/account/" title="Account">
      Account
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/endpoints/transaction/" title="Transaction">
      Transaction
    </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../engine/" title="Engine">
      Engine
    </a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-toggle md-nav__toggle" data-md-toggle="nav-9" id="nav-9" type="checkbox"/>
<label class="md-nav__link" for="nav-9">
      Tutorials
    </label>
<nav class="md-nav" data-md-component="collapsible" data-md-level="1">
<label class="md-nav__title" for="nav-9">
        Tutorials
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../inserting-data/" title="Inserting Data">
      Inserting Data
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../authorizations/" title="Authorizations">
      Authorizations
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../transactions/" title="Transactions">
      Transactions
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../kamailio-integration/" title="Kamailio Integration">
      Kamailio Integration
    </a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-toggle md-nav__toggle" data-md-toggle="toc" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
        Opensips Integration
      </label>
<a class="md-nav__link md-nav__link--active" href="./" title="Opensips Integration">
      Opensips Integration
    </a>
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#prerequisites">
    Prerequisites
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#scope">
    Scope
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#opensips-configuration">
    OpenSIPS configuration
  </a>
<nav class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#authorization">
    Authorization
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#begin-transaction">
    Begin Transaction
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#end-transaction">
    End Transaction
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#testing">
    Testing
  </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../faq/" title="FAQ">
      FAQ
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../license/" title="License">
      License
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../contributing/" title="Contributing">
      Contributing
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../code-of-conduct/" title="Code of conduct">
      Code of conduct
    </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#prerequisites">
    Prerequisites
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#scope">
    Scope
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#opensips-configuration">
    OpenSIPS configuration
  </a>
<nav class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#authorization">
    Authorization
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#begin-transaction">
    Begin Transaction
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#end-transaction">
    End Transaction
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#testing">
    Testing
  </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<h1 id="integration-with-opensips">Integration with OpenSIPS</h1>
<p><a href="https://www.opensips.org/">OpenSIPS</a> is an Open Source <a href="https://www.ietf.org/rfc/rfc3261.txt">SIP</a> proxy/server for voice, video, IM, presence and any other SIP extensions.</p>
<p>OpenSIPS is a multi-functional, multi-purpose signaling SIP server used by carriers, telecoms or ITSPs for solutions like Class4/5 Residential Platforms, Trunking / Wholesale, Enterprise / Virtual PBX Solutions, Session Border Controllers, Application Servers, Front-End Load Balancers, IMS Platforms, Call Centers, and many others - see the full Set of Features.</p>
<p>OpenSIPS is recommended for any kind of SIP scenario / service by:
* the <strong>high throughput</strong> - tens of thousands of CPS, millions of ‏simultaneous calls (see official tests)
* the <strong>flexibility of routing and integration</strong> - routing script for implementing custom routing logics, several interfacing APIs (see the Manual)
* the <strong>effective application building</strong> - more than 120 modules to provide features, for SIP handling, for backend operations, for integration, for routing logics (see List of Modules)</p>
<h2 id="prerequisites">Prerequisites</h2>
<p>The <a href="https://github.com/canyanio/rating-integration">integration repository</a> contains everything we need for understanding the usage of Canyan Rating Engine with OpenSIPS.
The <a href="https://github.com/canyanio/rating-integration/blob/master/Makefile">Makefile</a> provides us with two shortcut commands:
<code>make docker-start</code> and <code>make docker-stop</code>.</p>
<p>Also there is a <code>make test-opensips</code> command that we will look at in a while to understand what is happening behind the scenes.</p>
<h2 id="scope">Scope</h2>
<p>Integrating the authorization, begin and start transaction methods of the Rating Engine in an OpenSIPS instance.
OpenSIPS needs to perform an authorization for every outgoing and incoming call, getting all the information needed to perform or not the calls. Also the begin and end of a call needs to be signalized to the Rating Engine.</p>
<p>The Rating Agent is listening for http requests with REST and GraphQL APIs. In OpenSIPS we will use the <a href="https://opensips.org/docs/modules/3.0.x/rest_client.html">REST Module</a> in combination with <a href="https://www.opensips.org/Documentation/Script-Async-3-0">Asynchronous Statements</a> to avoid binding OpenSIPS workers with synchronous http calls.</p>
<h2 id="opensips-configuration">OpenSIPS configuration</h2>
<p>The integration repository contains an <a href="https://github.com/canyanio/rating-integration/blob/master/conf/opensips/rating.cfg">example configuration file</a> for the integration with Canyan's Rating Engine.</p>
<blockquote>
<p><strong>Note:</strong> The OpenSIPS configuration file is simple and basic for the purpose 
of this tutorial and should not be used in production.</p>
</blockquote>
<h3 id="authorization">Authorization</h3>
<p>Let's start with the authorization method of the Rating Engine.
In the <a href="https://github.com/canyanio/rating-integration/blob/master/conf/opensips/opensips.cfg">opensips.cfg</a> we can notice this piece of code:</p>
<div class="codehilite"><pre><span></span><span class="err">if (is_method("INVITE") &amp;&amp; !has_totag()) {</span>
<span class="err">  route(rating_authorization);</span>
<span class="err">}</span>
</pre></div>
<p>The route <code>rating_authorization</code> is run for every new <code>INVITE</code> method that does not have a <code>to</code> tag.</p>
<p><code>rating_authorization</code> prepares the json to be sent to the Rating Agent populating the following variables:</p>
<ul>
<li>transaction_tag (<code>$ci</code>)</li>
<li>account_tag (<code>$fU</code>)</li>
<li>source (<code>$fu</code>)</li>
<li>destination (<code>$tu</code>)</li>
</ul>
<p>The route <code>rating_authorization_response</code> is the most complex of the Canyan Rating Engine OpenSIPS integration routes.
It handles the response from the Agent to the <code>authorization</code> endpoint request.
Let's break it down and see what it does.</p>
<p>The first check is performed on the response from the Agent module. It checks if the http response is 200 then it checks if the response contains the expected fields.</p>
<p>Then the max available units are set to a variable that will be used if the call is authorized to set the dialog timeout with <code>DLG_timeout</code>.</p>
<p>The check of the unauthorized reasons is then performed to send the correct reply to the SIP client.</p>
<p>It there are no errors the prioritized carriers list is gathered from the authorization response and the top priority carrier is used in the <code>$du</code> variable.</p>
<p>At the end of the route the <code>relay</code> route is called.</p>
<h3 id="begin-transaction">Begin Transaction</h3>
<p>The route <code>rating_begin_transaction</code> is called within the <code>if</code> statement of the <a href="https://opensips.org/html/docs/modules/3.0.x/event_route.html">event route</a> for the <a href="https://opensips.org/docs/modules/3.0.x/dialog.html#event_E_DLG_STATE_CHANGED">E_DLG_STATE_CHANGED</a> event. The same event route is used for the end transaction. If the <code>$param(new_state)</code> is set to <code>4</code> it means that the dialog has started and that's where we trigger the route <code>rating_begin_transaction</code>.</p>
<p>The route prepares the following variables for the Rating Agent http async call:</p>
<ul>
<li>transaction_tag (<code>$avp(ci)</code>)</li>
<li>timestamp (<code>$Ts</code>)</li>
</ul>
<p>Please note that the <code>$avp(ci)</code> is populated in the event route with the <code>$param(callid)</code> from the event.</p>
<p>There is no need for other fields because the Rating Engine uses the <code>transaction_tag</code> to lookup for the data sent by the <code>rating_authorization</code> route.</p>
<p>Then the route <code>rating_begin_transaction_response</code> that handles the response from the Agent is doing some simple checks with <code>rcode</code>. The code then does the check of the content of the response which consists in checking if the variable <code>ok</code> is <code>true</code>.</p>
<p>If some of the checks are not good the route sends a <code>500 reply</code> to che client with a message that the Rating is not available. The route also prints an <code>xlog</code> with alert log level and the http error.</p>
<h3 id="end-transaction">End Transaction</h3>
<p>As for the <code>begin transaction</code>, the <code>end transaction</code> route is called with the <code>event route</code> on the dialog state change. In this case the new state is <code>5</code>.</p>
<p>The route <code>rating_end_transaction</code> sets the following variables to be sent to the Agent via http async call:</p>
<ul>
<li>transaction_tag (<code>$avp(ci)</code>)</li>
<li>timestamp (<code>$Ts</code>)</li>
</ul>
<p>Please note that the <code>$avp(ci)</code> is populated in the event route with the <code>$param(callid)</code> from the event.
Unfortunately we now loose the dialog variables because there is no more dialog but all we need is the <code>transaction_tag</code> because the Rating Engine is capable of restoring the needed information gathered from previous requests.</p>
<p>As for the Begin Transaction there is a simple <code>rating_end_transaction_response</code> route that handles the response from the Agent and checks the correct http response code and the value of the <code>ok</code> boolean variable inside the response body.
It sends SIP error replies and logs with alert log level if there is any issue.</p>
<h2 id="testing">Testing</h2>
<p>The integration repository contains also a <a href="https://github.com/canyanio/rating-integration/tree/master/tests">tests</a> directory that can be run with a simple <code>make test-opensips</code> after the <code>make docker-start</code> command. Please refer to those tests to see how the implementation inside OpenSIPS is tested with Canyan Rating Engine.</p>
<p>The tests are run with the open source tool <a href="https://github.com/canyanio/canyan-tester">canyan-tester</a> so refer to the documentation of that tool for better understanding the test process.</p>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav class="md-footer-nav__inner md-grid">
<a class="md-flex md-footer-nav__link md-footer-nav__link--prev" href="../kamailio-integration/" rel="prev" title="Kamailio Integration">
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
</div>
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
                  Previous
                </span>
                Kamailio Integration
              </span>
</div>
</a>
<a class="md-flex md-footer-nav__link md-footer-nav__link--next" href="../../faq/" rel="next" title="FAQ">
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
                  Next
                </span>
                FAQ
              </span>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
<div class="md-footer-copyright__highlight">
            Copyright © 2020 Canyan.io
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
</div>
<div class="md-footer-social">
<link href="../../assets/fonts/font-awesome.css" rel="stylesheet"/>
<a class="md-footer-social__link fa fa-github" href="https://github.com/canyanio"></a>
<a class="md-footer-social__link fa fa-twitter" href="https://twitter.com/canyan_io"></a>
<a class="md-footer-social__link fa fa-linkedin" href="https://www.linkedin.com/company/canyan/"></a>
<a class="md-footer-social__link fa fa-slack" href="http://slack.canyan.io"></a>
</div>
</div>
</div>
</footer>
</div>
<script src="../../assets/javascripts/application.808e90bb.js"></script>
<script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
<script src="https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js"></script>
</body>
</html>